<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bullen Audio Router</title>
  <style>
    :root { --bg: #0e1116; --fg: #e6e6e6; --muted: #999; --accent: #5ac8fa; --warn: #ff9f0a; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--fg); }
    header { padding: 12px 16px; border-bottom: 1px solid #222; display: flex; align-items: center; gap: 12px; }
    h1 { font-size: 18px; margin: 0; font-weight: 600; }
    main { padding: 16px; display: grid; gap: 16px; grid-template-columns: 1fr; max-width: 1100px; margin: 0 auto; }

    .panel { background: #141922; border: 1px solid #222; border-radius: 10px; padding: 16px; }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .spacer { flex: 1; }

    .channels { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
    button { background: #1e2735; color: var(--fg); border: 1px solid #2a3550; padding: 8px 10px; border-radius: 8px; cursor: pointer; }
    button:hover { background: #233048; }
    button.sel { background: var(--accent); color: #000; border-color: var(--accent); }

    .mute { background: #2a1f1f; border-color: #473333; }
    .mute.on { background: #d43f3f; border-color: #d43f3f; color: #000; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }

    .slider { display: grid; grid-template-columns: 60px 1fr 80px; align-items: center; gap: 8px; }
    input[type="range"] { width: 100%; }

    .meter { height: 12px; background: #0b0f15; border: 1px solid #1b2230; border-radius: 6px; position: relative; overflow: hidden; }
    .meter .bar { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: linear-gradient(90deg, #3ddc97, #ffd166, #ef476f); }
    .meter .peak { position: absolute; top: 0; bottom: 0; width: 2px; background: #ffd166; opacity: 0.9; }
    .label { font-size: 12px; color: var(--muted); }
    .small { font-size: 12px; color: var(--muted); }
    .card { padding: 12px; border: 1px solid #222; border-radius: 10px; background: #131722; }
    .info-icon { cursor: pointer; font-size: 14px; color: var(--accent); margin-left: 8px; }
    .info-icon:hover { opacity: 0.7; }
    .settings-content { display: grid; gap: 20px; }
    .setting-section { background: #0f1419; padding: 16px; border-radius: 8px; border: 1px solid #1a2332; }
    .setting-section h3 { margin: 0 0 8px 0; color: var(--accent); font-size: 16px; }
    .setting-section p { margin: 0 0 12px 0; line-height: 1.4; }
    .setting-section ul { margin: 0; padding-left: 20px; }
    .setting-section li { margin-bottom: 4px; line-height: 1.3; }
    .setting-section strong { color: var(--fg); }
    .test-content { display: grid; gap: 20px; }
    .test-info { background: #0f1419; padding: 12px; border-radius: 8px; border: 1px solid #1a2332; }
    .test-channels { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
    .test-channel { background: #131722; border: 1px solid #222; border-radius: 10px; padding: 16px; }
    .test-channel h4 { margin: 0 0 12px 0; color: var(--accent); display: flex; align-items: center; gap: 8px; }
    .test-channel.active { border-color: var(--accent); box-shadow: 0 0 10px rgba(90, 200, 250, 0.3); }
    .channel-status { font-size: 12px; padding: 2px 6px; border-radius: 4px; }
    .status-active { background: #2d5a2d; color: #90ee90; }
    .status-muted { background: #5a2d2d; color: #ff6b6b; }
    .status-inactive { background: #2d2d2d; color: #999; }
    .test-meter { height: 20px; background: #0b0f15; border: 1px solid #1b2230; border-radius: 10px; position: relative; overflow: hidden; margin: 8px 0; }
    .test-meter .bar { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: linear-gradient(90deg, #3ddc97, #ffd166, #ef476f); transition: width 0.1s ease; }
    .test-meter .peak { position: absolute; top: 0; bottom: 0; width: 3px; background: #ffd166; opacity: 0.9; transition: left 0.2s ease; }
    .test-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .control-section { background: #0f1419; padding: 16px; border-radius: 8px; border: 1px solid #1a2332; }
    .control-section h3 { margin: 0 0 12px 0; color: var(--accent); font-size: 16px; }
    .test-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .test-btn { padding: 10px 12px; border-radius: 8px; border: 1px solid #2a3550; background: #1e2735; color: var(--fg); cursor: pointer; font-size: 14px; }
    .test-btn:hover { background: #233048; }
    .test-btn.mute-all { background: #2a1f1f; border-color: #473333; }
    .test-btn.mute-all:hover { background: #3a2525; }
    .vu-controls { display: grid; gap: 8px; }
    .vu-controls label { display: flex; align-items: center; gap: 8px; font-size: 14px; }
    .channel-gain { display: grid; grid-template-columns: 1fr 60px; gap: 8px; align-items: center; margin: 8px 0; }
    .channel-gain input[type="range"] { width: 100%; }
    .channel-gain .gain-value { font-size: 12px; color: var(--muted); text-align: center; }
    .channel-mute { margin: 8px 0; }
    .channel-mute button { width: 100%; }
    /* Developer tools */
    .tabs { display: flex; gap: 8px; margin: 0 0 12px 0; flex-wrap: wrap; }
    .tab-btn { background: #1b2536; border: 1px solid #2a3550; color: var(--fg); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 13px; }
    .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .log { background: #0b0f15; border: 1px solid #1b2230; border-radius: 8px; padding: 8px; max-height: 220px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
    .field { display: grid; grid-template-columns: 160px 1fr; align-items: center; gap: 8px; margin-bottom: 8px; }
    .field input, .field select, .field textarea { width: 100%; background: #0f1419; border: 1px solid #1a2332; color: var(--fg); border-radius: 6px; padding: 6px 8px; font-size: 13px; }
    .two-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .danger { background: #592323; border-color: #7a2f2f; }
    @media (max-width: 768px) {
      .test-channels { grid-template-columns: 1fr; }
      .test-controls { grid-template-columns: 1fr; }
      .test-buttons { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Bullen Audio Router</h1>
    <div class="spacer"></div>
    <div class="small">Selected: <span id="selected">-</span></div>
    <button id="settingsBtn" onclick="toggleSettings()" style="margin-left: 8px;">‚öôÔ∏è Settings</button>
    <button id="testBtn" onclick="toggleTestView()" style="margin-left: 8px;">üîä Test</button>
  </header>

  <main id="mainView">
    <section class="panel">
      <div class="row" style="margin-bottom:8px;">
        <div class="label">Select channel</div>
        <div class="info-icon" onclick="showInfo('channel')" title="Click for more info">‚ÑπÔ∏è</div>
      </div>
      <div class="channels" id="channelButtons"></div>
    </section>

    <section class="panel">
      <div class="row" style="margin-bottom:8px;">
        <div class="label">Gains & Mutes</div>
        <div class="info-icon" onclick="showInfo('gain')" title="Click for more info">‚ÑπÔ∏è</div>
      </div>
      <div class="grid-3" id="gainMute"></div>
    </section>

    <section class="panel">
      <div class="row" style="margin-bottom:8px;">
        <div class="label">VU meters (RMS with peak marker)</div>
        <div class="info-icon" onclick="showInfo('vu')" title="Click for more info">‚ÑπÔ∏è</div>
      </div>
      <div class="grid" id="meters"></div>
    </section>
  </main>

  <main id="settingsView" style="display: none;">
    <section class="panel">
      <div class="row" style="margin-bottom:16px;">
        <h2 style="margin: 0; font-size: 20px;">Inst√§llningar & Information</h2>
        <div class="spacer"></div>
        <button onclick="toggleSettings()">‚Üê Tillbaka</button>
      </div>
      
      <div class="settings-content">
        <div class="setting-section">
          <h3>Kanalval</h3>
          <p>V√§lj vilken av de 6 ing√•ngskanalerna som ska skickas till h√∂rlurarna (L/R monitor). Den valda kanalen h√∂rs i b√•da √∂ronsn√§ckorna.</p>
          <ul>
            <li><strong>CH 1-6:</strong> Motsvarar fysiska ing√•ngar p√• Audio Injector Octo</li>
            <li><strong>Snabb v√§xling:</strong> Klicka p√• kanalknapparna f√∂r omedelbar v√§xling</li>
            <li><strong>Bl√• markering:</strong> Visar aktiv kanal</li>
          </ul>
        </div>

        <div class="setting-section">
          <h3>Gain & Mute</h3>
          <p>Justera volym och tysta individuella kanaler. Gain p√•verkar b√•de monitor och inspelning.</p>
          <ul>
            <li><strong>Gain-reglage:</strong> -60 dB till +20 dB, justeras i 0.5 dB-steg</li>
            <li><strong>Mute-knapp:</strong> R√∂d = tystad, gr√• = aktiv</li>
            <li><strong>Realtidsuppdatering:</strong> √Ñndringar till√§mpas omedelbart</li>
            <li><strong>Inspelning:</strong> Sker f√∂re gain/mute f√∂r att bevara originalljud</li>
          </ul>
        </div>

        <div class="setting-section">
          <h3>VU-m√§tare</h3>
          <p>Visar ljudniv√•er i realtid med b√•de RMS (genomsnittsniv√•) och peak (toppv√§rden).</p>
          <ul>
            <li><strong>Gr√∂n zon:</strong> Normala niv√•er (-60 till -20 dB)</li>
            <li><strong>Gul zon:</strong> H√∂ga niv√•er (-20 till -6 dB)</li>
            <li><strong>R√∂d zon:</strong> Risk f√∂r klippning (-6 till 0 dB)</li>
            <li><strong>Gul linje:</strong> Peak-mark√∂r visar h√∂gsta momentana niv√•</li>
            <li><strong>Uppdateringsfrekvens:</strong> ~20 Hz f√∂r smidig visning</li>
          </ul>
        </div>

        <div class="setting-section">
          <h3>Systeminformation</h3>
          <div id="systemInfo">
            <p>Laddar systeminformation...</p>
          </div>
        </div>

        <div class="setting-section">
          <h3>Tekniska detaljer</h3>
          <ul>
            <li><strong>Audio backend:</strong> <span id="backendInfo">-</span></li>
            <li><strong>Samplingsfrekvens:</strong> <span id="sampleRateInfo">-</span> Hz</li>
            <li><strong>Bufferstorlek:</strong> <span id="bufferSizeInfo">-</span> samples</li>
            <li><strong>Latens:</strong> ~<span id="latencyInfo">-</span> ms</li>
            <li><strong>Inspelning:</strong> <span id="recordingInfo">-</span></li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <main id="testView" style="display: none;">
    <section class="panel">
      <div class="row" style="margin-bottom:16px;">
        <h2 style="margin: 0; font-size: 20px;">Ljudkanal-test</h2>
        <div class="spacer"></div>
        <button onclick="toggleTestView()">‚Üê Tillbaka</button>
      </div>
      
      <div class="test-content">
        <div class="test-info">
          <p>Denna vy visar alla 6 ljudkanaler samtidigt f√∂r att testa och √∂vervaka ljudstr√∂mmar i realtid.</p>
        </div>
        
        <div class="test-channels" id="testChannels">
          <!-- Channels will be populated by JavaScript -->
        </div>
        
        <div class="test-controls">
          <div class="control-section">
            <h3>Test-kontroller</h3>
            <div class="test-buttons">
              <button onclick="testAllChannels()" class="test-btn">üîä Testa alla kanaler</button>
              <button onclick="resetAllGains()" class="test-btn">üîÑ √Öterst√§ll gain</button>
              <button onclick="muteAllChannels()" class="test-btn mute-all">üîá Tysta alla</button>
              <button onclick="unmuteAllChannels()" class="test-btn">üîä Aktivera alla</button>
            </div>
          </div>
          
          <div class="control-section">
            <h3>VU-m√§tare inst√§llningar</h3>
            <div class="vu-controls">
              <label>
                <input type="checkbox" id="vuPeakHold" checked> H√•ll peak-v√§rden
              </label>
              <label>
                <input type="range" id="vuSensitivity" min="0.1" max="2" step="0.1" value="1"> K√§nslighet
              </label>
            </div>
          </div>
        </div>

        <div class="control-section">
          <h3>Developer Tools</h3>
          <div class="tabs">
            <button class="tab-btn active" id="tab-api" onclick="devSetTab('api')">API Console</button>
            <button class="tab-btn" id="tab-ws" onclick="devSetTab('ws')">WS Inspector</button>
            <button class="tab-btn" id="tab-seq" onclick="devSetTab('seq')">Sequences</button>
            <button class="tab-btn" id="tab-metrics" onclick="devSetTab('metrics')">Metrics</button>
          </div>

          <div id="tabc-api" class="tab-content active">
            <div class="two-cols">
              <div>
                <div class="field"><label>Method</label>
                  <select id="apiMethod">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                  </select>
                </div>
                <div class="field"><label>Path</label>
                  <input id="apiPath" value="/api/state" placeholder="/api/state" />
                </div>
                <div class="field"><label>Body (JSON)</label>
                  <textarea id="apiBody" rows="8" placeholder="{ }"></textarea>
                </div>
                <div class="row" style="gap:8px; flex-wrap: wrap;">
                  <button class="test-btn" onclick="devSendApi()">Send</button>
                  <button class="test-btn" onclick="devFillApi('state')">/api/state</button>
                  <button class="test-btn" onclick="devFillApi('config')">/api/config</button>
                  <button class="test-btn" onclick="devFillApi('select')">select CH1</button>
                  <button class="test-btn" onclick="devFillApi('gaindb')">gain CH1 -6 dB</button>
                  <button class="test-btn" onclick="devFillApi('mute')">mute CH1</button>
                </div>
              </div>
              <div>
                <div class="field"><label>Status</label><input id="apiStatus" readonly /></div>
                <div class="field"><label>Time (ms)</label><input id="apiTime" readonly /></div>
                <div class="log" id="apiResponse" style="min-height: 200px;"></div>
              </div>
            </div>
          </div>

          <div id="tabc-ws" class="tab-content">
            <div class="row" style="gap:8px; margin-bottom:8px; flex-wrap: wrap;">
              <button class="test-btn" id="wsPauseBtn" onclick="devWsToggle()">Pause logging</button>
              <button class="test-btn" onclick="devWsClear()">Clear</button>
              <button class="test-btn" onclick="devWsCopyLast()">Copy last</button>
              <button class="test-btn" onclick="devWsDownload()">Download log</button>
            </div>
            <div class="two-cols">
              <div class="log" id="wsLog"></div>
              <div>
                <div class="field"><label>Total messages</label><input id="wsCount" readonly/></div>
                <div class="field"><label>Avg interval (ms)</label><input id="wsAvg" readonly/></div>
                <div class="field"><label>Min/Max interval (ms)</label><input id="wsMinMax" readonly/></div>
                <div class="field"><label>Approx rate (Hz)</label><input id="wsRate" readonly/></div>
                <div class="field"><label>Last received</label><input id="wsLastTime" readonly/></div>
              </div>
            </div>
          </div>

          <div id="tabc-seq" class="tab-content">
            <div class="two-cols">
              <div>
                <h4 style="margin:0 0 8px 0;">Cycle channels</h4>
                <div class="field"><label>Delay per channel (ms)</label><input id="seqCycleDelay" type="number" value="500"/></div>
                <div class="field"><label>Loops</label><input id="seqCycleLoops" type="number" value="1"/></div>
                <div class="row" style="gap:8px;"><button class="test-btn" onclick="devSeqStart('cycle')">Start</button></div>
              </div>
              <div>
                <h4 style="margin:0 0 8px 0;">Ramp gains</h4>
                <div class="field"><label>Min (dB)</label><input id="seqRampMin" type="number" value="-18"/></div>
                <div class="field"><label>Max (dB)</label><input id="seqRampMax" type="number" value="0"/></div>
                <div class="field"><label>Step (dB)</label><input id="seqRampStep" type="number" value="3"/></div>
                <div class="field"><label>Delay (ms)</label><input id="seqRampDelay" type="number" value="200"/></div>
                <div class="row" style="gap:8px;"><button class="test-btn" onclick="devSeqStart('ramp')">Start</button></div>
              </div>
            </div>
            <div class="two-cols" style="margin-top: 12px;">
              <div>
                <h4 style="margin:0 0 8px 0;">Mute/unmute all</h4>
                <div class="field"><label>Delay (ms)</label><input id="seqMuteDelay" type="number" value="500"/></div>
                <div class="row" style="gap:8px;">
                  <button class="test-btn" onclick="devSeqStart('mute')">Start</button>
                  <button class="test-btn danger" onclick="devSeqStopAll()">Stop all</button>
                </div>
              </div>
              <div>
                <h4 style="margin:0 0 8px 0;">Status</h4>
                <div class="log" id="seqStatus" style="min-height: 120px;"></div>
              </div>
            </div>
          </div>

          <div id="tabc-metrics" class="tab-content">
            <div id="metricsContent" class="log" style="min-height:120px;"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const N = 6;
    const channelButtons = document.getElementById('channelButtons');
    const meters = document.getElementById('meters');
    const gainMute = document.getElementById('gainMute');
    const selectedEl = document.getElementById('selected');

    // Build controls
    for (let i = 1; i <= N; i++) {
      const b = document.createElement('button');
      b.textContent = `CH ${i}`;
      b.id = `btn-${i}`;
      b.onclick = () => selectChannel(i);
      channelButtons.appendChild(b);

      const card = document.createElement('div');
      card.className = 'card';

      const row1 = document.createElement('div');
      row1.className = 'row';
      const mute = document.createElement('button');
      mute.textContent = 'Mute';
      mute.className = 'mute';
      mute.id = `mute-${i}`;
      mute.onclick = () => setMute(i, !(mute.classList.contains('on')));
      row1.appendChild(mute);
      card.appendChild(row1);

      const slider = document.createElement('div');
      slider.className = 'slider';
      const label = document.createElement('div'); label.textContent = `CH ${i}`; slider.appendChild(label);
      const range = document.createElement('input');
      range.type = 'range'; range.min = -60; range.max = 20; range.step = 0.5; range.value = 0; range.id = `gain-${i}`;
      range.oninput = () => setGainDb(i, parseFloat(range.value));
      slider.appendChild(range);
      const val = document.createElement('div'); val.className = 'small'; val.id = `gaindb-${i}`; val.textContent = '0.0 dB'; slider.appendChild(val);
      card.appendChild(slider);

      gainMute.appendChild(card);

      const mcard = document.createElement('div');
      mcard.className = 'card';
      const title = document.createElement('div'); title.className = 'small'; title.textContent = `CH ${i}`; mcard.appendChild(title);
      const meter = document.createElement('div'); meter.className = 'meter'; meter.id = `meter-${i}`;
      const bar = document.createElement('div'); bar.className = 'bar'; bar.id = `bar-${i}`; meter.appendChild(bar);
      const pk = document.createElement('div'); pk.className = 'peak'; pk.id = `peak-${i}`; meter.appendChild(pk);
      mcard.appendChild(meter);
      meters.appendChild(mcard);
    }

    // API helpers
    /**
     * Select a channel for monitoring
     * @param {number} ch - Channel number (1-based)
     */
    async function selectChannel(ch) {
      // Send POST request to select channel API endpoint
      await fetch(`/api/select/${ch}`, { method: 'POST' });
      // Update UI to highlight selected channel
      highlightSelected(ch);
    }

    /**
     * Set gain for a specific channel in decibels
     * @param {number} ch - Channel number (1-based)
     * @param {number} db - Gain value in decibels
     */
    async function setGainDb(ch, db) {
      // Send POST request to gain API endpoint with dB value
      await fetch(`/api/gain/${ch}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ gain_db: db }) });
      // Update gain display label with new value
      const el = document.getElementById(`gaindb-${ch}`); if (el) el.textContent = `${db.toFixed(1)} dB`;
    }

    /**
     * Set mute status for a specific channel
     * @param {number} ch - Channel number (1-based)
     * @param {boolean} on - Mute status (true for muted, false for unmuted)
     */
    async function setMute(ch, on) {
      // Send POST request to mute API endpoint with mute status
      await fetch(`/api/mute/${ch}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mute: on }) });
      // Update mute button UI to reflect new status
      const btn = document.getElementById(`mute-${ch}`);
      if (btn) btn.classList.toggle('on', on);
    }

    /**
     * Highlight the selected channel in the UI
     * @param {number} ch - Channel number (1-based)
     */
    function highlightSelected(ch) {
      // Update selected channel display
      selectedEl.textContent = ch;
      // Toggle selected class on channel buttons
      for (let i = 1; i <= N; i++) {
        document.getElementById(`btn-${i}`).classList.toggle('sel', i === ch);
      }
    }

    /**
     * Convert linear value to decibels
     * @param {number} v - Linear value
     * @returns {number} Value in decibels
     */
    function vToDb(v) { const eps = 1e-9; return 20 * Math.log10(Math.max(eps, v)); }
    
    /**
     * Normalize dB value to range 0-1 for meter display
     * @param {number} db - Decibel value
     * @returns {number} Normalized value between 0 and 1
     */
    function normFromDb(db) { const minDb = -60; const maxDb = 0; return Math.max(0, Math.min(1, (db - minDb) / (maxDb - minDb))); }

    /**
     * Update VU meter displays with new values
     * @param {Object} vu - VU meter data object
     */
    function updateVU(vu) {
      // Extract VU data from payload
      const { vu_rms, vu_peak, selected_channel, mutes, gains_db } = vu;
      // Update selected channel highlight
      highlightSelected(selected_channel);
      // Update each channel's VU meter display
      for (let i = 1; i <= N; i++) {
        const idx = i - 1;
        // Convert RMS and peak values to decibels
        const rmsDb = vToDb(vu_rms[idx]);
        const pkDb = vToDb(vu_peak[idx]);
        // Get UI elements for this channel
        const bar = document.getElementById(`bar-${i}`);
        const pk = document.getElementById(`peak-${i}`);
        const muteBtn = document.getElementById(`mute-${i}`);
        const gainLabel = document.getElementById(`gaindb-${i}`);
        const gainSlider = document.getElementById(`gain-${i}`);
        // Update meter bar width based on RMS value
        if (bar) bar.style.width = `${(normFromDb(rmsDb) * 100).toFixed(1)}%`;
        // Update peak marker position
        if (pk) pk.style.left = `${(normFromDb(pkDb) * 100).toFixed(1)}%`;
        // Update mute button status
        if (muteBtn) muteBtn.classList.toggle('on', !!mutes[idx]);
        // Update gain display label
        if (gainLabel) gainLabel.textContent = `${(gains_db[idx]).toFixed(1)} dB`;
        // Update gain slider position
        if (gainSlider) gainSlider.value = gains_db[idx];
      }
    }

    /**
     * Initialize application state by fetching current engine state
     */
    async function initState() {
      // Fetch current engine state from API
      const r = await fetch('/api/state');
      // Parse JSON response
      const s = await r.json();
      // Update VU meters with initial state
      updateVU(s);
    }

    /**
     * Connect to WebSocket for VU meter updates
     */
    function wsConnect() {
      // Determine WebSocket protocol based on page protocol
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      // Create WebSocket connection
      const ws = new WebSocket(`${proto}://${location.host}/ws/vu`);
      // Send ping message every 2 seconds to keep connection alive
      let pingTimer = null;
      ws.onopen = () => {
        pingTimer = setInterval(() => { try { ws.send('ping'); } catch(e){} }, 2000);
      };
      // Handle incoming VU meter updates
      ws.onmessage = (ev) => { 
        try { 
          const data = JSON.parse(ev.data); 
          devOnWs(data);
          updateVU(data); 
          // Also update test view if visible
          const testView = document.getElementById('testView');
          if (testView && testView.style.display !== 'none') {
            updateTestVU(data);
          }
        } catch(e){} 
      };
      // Reconnect if connection is closed
      ws.onclose = () => {
        if (pingTimer) { try { clearInterval(pingTimer); } catch(e){} }
        setTimeout(wsConnect, 2000);
      };
      // Clear ping timer on error as well
      ws.onerror = () => {
        if (pingTimer) { try { clearInterval(pingTimer); } catch(e){} }
      };
    }

    /**
     * Toggle between main view and settings view
     */
    function toggleSettings() {
      const mainView = document.getElementById('mainView');
      const settingsView = document.getElementById('settingsView');
      const isSettingsVisible = settingsView.style.display !== 'none';
      
      if (isSettingsVisible) {
        mainView.style.display = 'block';
        settingsView.style.display = 'none';
      } else {
        mainView.style.display = 'none';
        settingsView.style.display = 'block';
        loadSystemInfo();
      }
    }

    /**
     * Show information popup for specific feature
     * @param {string} type - Type of info to show
     */
    function showInfo(type) {
      const messages = {
        channel: 'Kanalval: V√§lj vilken ing√•ng som ska h√∂ras i h√∂rlurarna. Den valda kanalen (bl√•) skickas till b√•de v√§nster och h√∂ger h√∂rlurar.',
        gain: 'Gain & Mute: Justera volym (-60 till +20 dB) och tysta kanaler. R√∂d mute-knapp = tystad. Gain p√•verkar b√•de monitor och inspelning.',
        vu: 'VU-m√§tare: Gr√∂n = normalt, gul = h√∂gt, r√∂d = risk f√∂r klippning. Stapeln visar RMS-niv√•, gul linje visar peak-v√§rde.'
      };
      alert(messages[type] || 'Information inte tillg√§nglig.');
    }

    /**
     * Load system information for settings view
     */
    async function loadSystemInfo() {
      try {
        const [stateRes, configRes] = await Promise.all([
          fetch('/api/state'),
          fetch('/api/config')
        ]);
        const state = await stateRes.json();
        const config = await configRes.json();
        
        // Update system info elements
        document.getElementById('backendInfo').textContent = config.backend || 'jack';
        document.getElementById('sampleRateInfo').textContent = state.samplerate || '-';
        document.getElementById('bufferSizeInfo').textContent = state.frames_per_period || '-';
        
        // Calculate approximate latency
        const latency = state.samplerate && state.frames_per_period ? 
          ((state.frames_per_period * 2) / state.samplerate * 1000).toFixed(1) : '-';
        document.getElementById('latencyInfo').textContent = latency;
        
        document.getElementById('recordingInfo').textContent = state.recording ? 'Aktiverad' : 'Inaktiverad';
        
        // System info summary
        const systemInfoEl = document.getElementById('systemInfo');
        systemInfoEl.innerHTML = `
          <p><strong>Status:</strong> Ansluten och aktiv</p>
          <p><strong>Kanaler:</strong> ${config.inputs || 6} ing√•ngar, ${config.outputs || 2} utg√•ngar</p>
          <p><strong>Vald kanal:</strong> CH ${state.selected_channel || 1}</p>
          <p><strong>Inspelningar:</strong> ${config.recordings_dir || 'recordings'}/</p>
        `;
      } catch (error) {
        document.getElementById('systemInfo').innerHTML = '<p style="color: var(--warn);">Kunde inte ladda systeminformation</p>';
      }
    }

    /**
     * Toggle between main view and test view
     */
    function toggleTestView() {
      const mainView = document.getElementById('mainView');
      const settingsView = document.getElementById('settingsView');
      const testView = document.getElementById('testView');
      const isTestVisible = testView.style.display !== 'none';
      
      if (isTestVisible) {
        mainView.style.display = 'block';
        settingsView.style.display = 'none';
        testView.style.display = 'none';
      } else {
        mainView.style.display = 'none';
        settingsView.style.display = 'none';
        testView.style.display = 'block';
        initTestView();
      }
    }

    /**
     * Initialize test view with channel controls
     */
    function initTestView() {
      const testChannels = document.getElementById('testChannels');
      testChannels.innerHTML = '';
      
      for (let i = 1; i <= N; i++) {
        const channel = document.createElement('div');
        channel.className = 'test-channel';
        channel.id = `test-channel-${i}`;
        
        channel.innerHTML = `
          <h4>
            CH ${i}
            <span class="channel-status status-inactive" id="test-status-${i}">Inaktiv</span>
          </h4>
          
          <div class="test-meter" id="test-meter-${i}">
            <div class="bar" id="test-bar-${i}"></div>
            <div class="peak" id="test-peak-${i}"></div>
          </div>
          
          <div class="channel-gain">
            <input type="range" id="test-gain-${i}" min="-60" max="20" step="0.5" value="0" 
                   oninput="setGainDb(${i}, parseFloat(this.value)); updateTestGainDisplay(${i}, this.value)">
            <div class="gain-value" id="test-gain-value-${i}">0.0 dB</div>
          </div>
          
          <div class="channel-mute">
            <button class="mute" id="test-mute-${i}" onclick="toggleChannelMute(${i})">
              Mute CH ${i}
            </button>
          </div>
        `;
        
        testChannels.appendChild(channel);
      }
    }

    /**
     * Update test view with VU data
     */
    function updateTestVU(vu) {
      const { vu_rms, vu_peak, selected_channel, mutes, gains_db } = vu;
      const vuSensitivity = parseFloat(document.getElementById('vuSensitivity')?.value || 1);
      const peakHold = document.getElementById('vuPeakHold')?.checked || false;
      
      for (let i = 1; i <= N; i++) {
        const idx = i - 1;
        const rmsDb = vToDb(vu_rms[idx]) * vuSensitivity;
        const pkDb = vToDb(vu_peak[idx]) * vuSensitivity;
        
        // Update meters
        const bar = document.getElementById(`test-bar-${i}`);
        const peak = document.getElementById(`test-peak-${i}`);
        const status = document.getElementById(`test-status-${i}`);
        const channel = document.getElementById(`test-channel-${i}`);
        const muteBtn = document.getElementById(`test-mute-${i}`);
        const gainSlider = document.getElementById(`test-gain-${i}`);
        const gainValue = document.getElementById(`test-gain-value-${i}`);
        
        if (bar) bar.style.width = `${(normFromDb(rmsDb) * 100).toFixed(1)}%`;
        if (peak) {
          const peakPos = `${(normFromDb(pkDb) * 100).toFixed(1)}%`;
          if (!peakHold || parseFloat(peak.style.left || '0%') < parseFloat(peakPos)) {
            peak.style.left = peakPos;
          }
        }
        
        // Update status and highlighting
        if (status && channel) {
          const isActive = vu_rms[idx] > 0.001; // Threshold for "active"
          const isMuted = mutes[idx];
          const isSelected = i === selected_channel;
          
          if (isMuted) {
            status.textContent = 'Tystad';
            status.className = 'channel-status status-muted';
          } else if (isActive) {
            status.textContent = 'Aktiv';
            status.className = 'channel-status status-active';
          } else {
            status.textContent = 'Inaktiv';
            status.className = 'channel-status status-inactive';
          }
          
          channel.classList.toggle('active', isSelected);
        }
        
        // Update controls
        if (muteBtn) muteBtn.classList.toggle('on', mutes[idx]);
        if (gainSlider) gainSlider.value = gains_db[idx];
        if (gainValue) gainValue.textContent = `${gains_db[idx].toFixed(1)} dB`;
      }
    }

    /**
     * Update gain display in test view
     */
    function updateTestGainDisplay(ch, value) {
      const gainValue = document.getElementById(`test-gain-value-${ch}`);
      if (gainValue) gainValue.textContent = `${parseFloat(value).toFixed(1)} dB`;
    }

    /**
     * Toggle mute for a channel in test view
     */
    async function toggleChannelMute(ch) {
      const btn = document.getElementById(`test-mute-${ch}`);
      const isMuted = btn.classList.contains('on');
      await setMute(ch, !isMuted);
    }

    /**
     * Test all channels by cycling through them
     */
    async function testAllChannels() {
      for (let i = 1; i <= N; i++) {
        await selectChannel(i);
        await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second per channel
      }
    }

    /**
     * Reset all gains to 0 dB
     */
    async function resetAllGains() {
      for (let i = 1; i <= N; i++) {
        await setGainDb(i, 0);
        updateTestGainDisplay(i, 0);
      }
    }

    /**
     * Mute all channels
     */
    async function muteAllChannels() {
      for (let i = 1; i <= N; i++) {
        await setMute(i, true);
      }
    }

    /**
     * Unmute all channels
     */
    async function unmuteAllChannels() {
      for (let i = 1; i <= N; i++) {
        await setMute(i, false);
      }
    }

    // ----- Developer Tools -----
    const dev = {
      paused: false,
      lastTs: null,
      intervals: [], // ms
      maxIntervals: 200,
      count: 0,
      log: [],
      maxLog: 200,
      seqStop: false,
      rmsMax: Array(N).fill(0),
      peakMax: Array(N).fill(0),
    };

    function devSetTab(key) {
      const tabs = ['api','ws','seq','metrics'];
      tabs.forEach(t => {
        const btn = document.getElementById(`tab-${t}`);
        const c = document.getElementById(`tabc-${t}`);
        if (btn) btn.classList.toggle('active', t === key);
        if (c) c.classList.toggle('active', t === key);
      });
    }

    async function devSendApi() {
      const method = document.getElementById('apiMethod').value;
      const path = document.getElementById('apiPath').value.trim() || '/api/state';
      const bodyText = document.getElementById('apiBody').value.trim();
      const statusEl = document.getElementById('apiStatus');
      const timeEl = document.getElementById('apiTime');
      const respEl = document.getElementById('apiResponse');
      let init = { method, headers: {} };
      if (method === 'POST') {
        init.headers['Content-Type'] = 'application/json';
        try { init.body = bodyText ? JSON.stringify(JSON.parse(bodyText)) : '{}'; }
        catch (e) { respEl.textContent = `Body JSON parse error: ${e}`; return; }
      }
      const t0 = performance.now();
      try {
        const r = await fetch(path, init);
        const t1 = performance.now();
        statusEl.value = `${r.status} ${r.statusText}`;
        timeEl.value = (t1 - t0).toFixed(1);
        let txt = await r.text();
        try { const j = JSON.parse(txt); txt = JSON.stringify(j, null, 2); } catch (_) {}
        respEl.textContent = txt;
      } catch (e) {
        statusEl.value = 'ERROR';
        timeEl.value = '-';
        respEl.textContent = String(e);
      }
    }

    function devFillApi(kind) {
      const method = document.getElementById('apiMethod');
      const path = document.getElementById('apiPath');
      const body = document.getElementById('apiBody');
      if (kind === 'state') { method.value = 'GET'; path.value = '/api/state'; body.value = ''; }
      if (kind === 'config') { method.value = 'GET'; path.value = '/api/config'; body.value = ''; }
      if (kind === 'select') { method.value = 'POST'; path.value = '/api/select/1'; body.value = '{}'; }
      if (kind === 'gaindb') { method.value = 'POST'; path.value = '/api/gain/1'; body.value = '{"gain_db": -6}'; }
      if (kind === 'mute') { method.value = 'POST'; path.value = '/api/mute/1'; body.value = '{"mute": true}'; }
    }

    function devOnWs(payload) {
      const now = Date.now();
      if (dev.lastTs != null) {
        const dt = now - dev.lastTs;
        dev.intervals.push(dt);
        if (dev.intervals.length > dev.maxIntervals) dev.intervals.shift();
      }
      dev.lastTs = now;
      dev.count += 1;
      // track maxima
      if (payload && payload.vu_rms && payload.vu_peak) {
        for (let i = 0; i < Math.min(N, payload.vu_rms.length); i++) {
          dev.rmsMax[i] = Math.max(dev.rmsMax[i], payload.vu_rms[i] || 0);
          dev.peakMax[i] = Math.max(dev.peakMax[i], payload.vu_peak[i] || 0);
        }
      }
      // log line
      try {
        const line = JSON.stringify({ t: now, payload });
        dev.log.push(line);
        if (dev.log.length > dev.maxLog) dev.log.shift();
        if (!dev.paused) {
          const el = document.getElementById('wsLog');
          if (el) {
            const ts = new Date(now).toLocaleTimeString();
            const short = JSON.stringify(payload).slice(0, 200);
            const div = document.createElement('div');
            div.textContent = `[${ts}] ${short}`;
            el.appendChild(div);
            // trim dom children
            while (el.childNodes.length > dev.maxLog) el.removeChild(el.firstChild);
            el.scrollTop = el.scrollHeight;
          }
        }
      } catch (_) {}
      devUpdateMetrics();
    }

    function devUpdateMetrics() {
      const cnt = dev.count;
      const avg = dev.intervals.length ? (dev.intervals.reduce((a,b)=>a+b,0) / dev.intervals.length) : 0;
      const min = dev.intervals.length ? Math.min(...dev.intervals) : 0;
      const max = dev.intervals.length ? Math.max(...dev.intervals) : 0;
      const rate = avg > 0 ? (1000 / avg) : 0;
      const last = dev.lastTs ? new Date(dev.lastTs).toLocaleTimeString() : '-';
      const wsCount = document.getElementById('wsCount'); if (wsCount) wsCount.value = String(cnt);
      const wsAvg = document.getElementById('wsAvg'); if (wsAvg) wsAvg.value = avg.toFixed(1);
      const wsMinMax = document.getElementById('wsMinMax'); if (wsMinMax) wsMinMax.value = `${min.toFixed(1)} / ${max.toFixed(1)}`;
      const wsRate = document.getElementById('wsRate'); if (wsRate) wsRate.value = rate.toFixed(2);
      const wsLastTime = document.getElementById('wsLastTime'); if (wsLastTime) wsLastTime.value = last;
      // metrics tab content
      const mc = document.getElementById('metricsContent');
      if (mc) {
        const toDb = v => 20 * Math.log10(Math.max(1e-9, v));
        const rmsDb = dev.rmsMax.map(toDb).map(v=>v.toFixed(1));
        const peakDb = dev.peakMax.map(toDb).map(v=>v.toFixed(1));
        mc.textContent = [
          `WS messages: ${cnt}`,
          `Avg dt: ${avg.toFixed(1)} ms (min ${min.toFixed(1)}, max ${max.toFixed(1)})`,
          `Approx rate: ${rate.toFixed(2)} Hz`,
          `Last: ${last}`,
          `RMS max (dB): [${rmsDb.join(', ')}]`,
          `Peak max (dB): [${peakDb.join(', ')}]`
        ].join('\n');
      }
    }

    function devWsToggle() {
      dev.paused = !dev.paused;
      const b = document.getElementById('wsPauseBtn');
      if (b) b.textContent = dev.paused ? 'Resume logging' : 'Pause logging';
    }
    function devWsClear() {
      dev.log = [];
      const el = document.getElementById('wsLog'); if (el) el.innerHTML = '';
    }
    function devWsCopyLast() {
      if (!dev.log.length) return;
      const last = dev.log[dev.log.length - 1];
      if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(last);
      else {
        const ta = document.createElement('textarea'); ta.value = last; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      }
    }
    function devWsDownload() {
      const blob = new Blob([dev.log.join('\n')], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `ws_log_${Date.now()}.jsonl`; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    async function devSeqStart(kind) {
      dev.seqStop = false;
      const status = document.getElementById('seqStatus');
      const log = (msg) => { if (status) { const line = document.createElement('div'); line.textContent = msg; status.appendChild(line); status.scrollTop = status.scrollHeight; } };
      if (kind === 'cycle') {
        const delay = parseInt(document.getElementById('seqCycleDelay').value || '500', 10);
        const loops = parseInt(document.getElementById('seqCycleLoops').value || '1', 10);
        log(`Start cycle: delay ${delay} ms, loops ${loops}`);
        for (let L = 0; L < loops && !dev.seqStop; L++) {
          for (let i = 1; i <= N && !dev.seqStop; i++) {
            await selectChannel(i);
            log(`Select CH ${i}`);
            await new Promise(r => setTimeout(r, delay));
          }
        }
        log('Cycle done.');
      }
      if (kind === 'ramp') {
        const min = parseFloat(document.getElementById('seqRampMin').value || '-18');
        const max = parseFloat(document.getElementById('seqRampMax').value || '0');
        const step = parseFloat(document.getElementById('seqRampStep').value || '3');
        const delay = parseInt(document.getElementById('seqRampDelay').value || '200', 10);
        log(`Start ramp: ${min}..${max} dB step ${step}, delay ${delay} ms`);
        const values = [];
        for (let v = min; v <= max + 1e-9; v += step) values.push(v);
        for (let i = 1; i <= N && !dev.seqStop; i++) {
          for (const v of values) {
            if (dev.seqStop) break;
            await setGainDb(i, v);
            log(`CH ${i} gain ${v.toFixed(1)} dB`);
            await new Promise(r => setTimeout(r, delay));
          }
        }
        log('Ramp done.');
      }
      if (kind === 'mute') {
        const delay = parseInt(document.getElementById('seqMuteDelay').value || '500', 10);
        log('Mute all');
        for (let i = 1; i <= N; i++) { if (dev.seqStop) break; await setMute(i, true); }
        await new Promise(r => setTimeout(r, delay));
        log('Unmute all');
        for (let i = 1; i <= N; i++) { if (dev.seqStop) break; await setMute(i, false); }
        log('Mute/unmute sequence done.');
      }
    }
    function devSeqStopAll() { dev.seqStop = true; const status = document.getElementById('seqStatus'); if (status) { const d = document.createElement('div'); d.textContent = 'STOP requested'; status.appendChild(d); } }

    // Init
    initState();
    wsConnect();
  </script>
</body>
</html>
